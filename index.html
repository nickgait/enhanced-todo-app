<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Todo App</title>
    <style>
        /* This styles our app to look nice */
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .stats-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .stat-item {
            background: white;
            padding: 10px 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .verse-container {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 3px solid #007bff;
            font-style: italic;
            color: #495057;
        }

        .verse-text {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .verse-reference {
            font-size: 12px;
            color: #666;
            text-align: right;
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        input[type="text"], input[type="date"], textarea, select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }

        input[type="text"] {
            flex: 2;
        }

        input[type="date"] {
            flex: 1;
        }

        textarea {
            flex: 1;
            min-height: 60px;
            resize: vertical;
        }

        select {
            flex: 1;
        }

        label {
            font-weight: bold;
            min-width: 80px;
            font-size: 14px;
            color: #495057;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .todo-list {
            list-style: none;
            padding: 0;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .filter-btn {
            padding: 8px 16px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn.active {
            background-color: #007bff;
        }

        .filter-btn:hover {
            opacity: 0.8;
        }

        .todo-item {
            background: #fff;
            margin: 15px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .todo-item.completed {
            background: #f8f9fa;
            border-left-color: #28a745;
            opacity: 0.8;
        }

        .todo-item.priority-high {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .todo-item.priority-medium {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .todo-item.priority-low {
            border-left-color: #28a745;
            background: #f8fff8;
        }

        .todo-item.priority-high.completed {
            background: #f8f9fa;
            border-left-color: #28a745;
        }

        .todo-item.priority-medium.completed {
            background: #f8f9fa;
            border-left-color: #28a745;
        }

        .todo-item.priority-low.completed {
            background: #f8f9fa;
            border-left-color: #28a745;
        }

        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .priority-high {
            background: #ffebee;
            color: #c62828;
        }

        .priority-medium {
            background: #fff8e1;
            color: #ef6c00;
        }

        .priority-low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .categories-container {
            margin: 10px 0;
        }

        .category-tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            border: 1px solid #ced4da;
        }

        .category-tag:hover {
            background: #dee2e6;
            cursor: pointer;
        }

        /* Animation and Transition Styles */
        
        /* Smooth transitions for all interactive elements */
        button, input, select, textarea, .category-tag, .priority-badge, .stat-item {
            transition: all 0.3s ease;
        }

        /* Todo item animations */
        .todo-item {
            animation: slideInUp 0.4s ease-out;
            transition: all 0.3s ease;
        }

        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Keyframe animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
                max-height: 200px;
                margin: 15px 0;
                padding: 20px;
            }
            to {
                opacity: 0;
                transform: translateX(-100%);
                max-height: 0;
                margin: 0;
                padding: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Button hover animations */
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Input focus animations */
        input:focus, textarea:focus, select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
            transform: scale(1.02);
        }

        /* Statistics counter animation */
        .stat-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .stat-number {
            transition: all 0.3s ease;
        }

        /* Loading animation for buttons */
        .loading {
            position: relative;
            color: transparent !important;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Fade in animation for filtered content */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        /* Error shake animation */
        .error-shake {
            animation: shake 0.5s ease-in-out;
            border-color: #dc3545 !important;
        }

        /* Success pulse animation */
        .success-pulse {
            animation: pulse 0.6s ease-in-out;
        }

        /* Smooth category tag animations */
        .category-tag {
            transition: all 0.2s ease;
            transform: scale(1);
        }

        .category-tag:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Priority badge animations */
        .priority-badge {
            transition: all 0.3s ease;
        }

        .priority-badge:hover {
            transform: scale(1.1);
        }

        /* Smooth filter button transitions */
        .filter-btn {
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .filter-btn:hover::before {
            left: 100%;
        }

        /* Drag and Drop Styles */
        .todo-item {
            cursor: grab;
        }

        .todo-item:active {
            cursor: grabbing;
        }

        .todo-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .todo-item.drag-over {
            border-top: 3px solid #007bff;
            transform: translateY(-2px);
        }

        .drag-placeholder {
            height: 80px;
            margin: 15px 0;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: rgba(0,123,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #007bff;
            font-style: italic;
        }

        /* Bulk Selection Styles */
        .bulk-actions {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #007bff;
            align-items: center;
            gap: 15px;
        }

        .bulk-actions.visible {
            display: flex;
        }

        .bulk-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .todo-item.selected {
            background: #e3f2fd;
            border-left-color: #2196f3;
            transform: scale(1.02);
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .todo-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            flex: 1;
        }

        .todo-title.completed {
            text-decoration: line-through;
            color: #6c757d;
        }

        .todo-actions {
            display: flex;
            gap: 10px;
        }

        .todo-details {
            margin-bottom: 15px;
            color: #666;
        }

        .todo-description {
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.4;
        }

        .todo-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 14px;
        }

        .todo-meta span {
            white-space: nowrap;
        }

        .todo-due-date {
            color: #dc3545;
        }

        .todo-due-date.completed {
            color: #6c757d;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }

        .edit-btn {
            background-color: #17a2b8;
            padding: 8px 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .edit-btn:hover {
            background-color: #138496;
        }

        .delete-btn {
            background-color: #dc3545;
            padding: 8px 12px;
            font-size: 12px;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>My Enhanced Todo App</h1>
        
        <div class="app-header">
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="inProgressTasks">0</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div class="stat-label">Weighted Completion</div>
                </div>
            </div>
            
            <div class="verse-container" id="dailyVerse">
                <div class="verse-text" id="verseText">Loading daily verse...</div>
                <div class="verse-reference" id="verseReference"></div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="form-row">
                <label>Task:</label>
                <input type="text" id="todoInput" placeholder="Enter task title..." required>
                <label>Due Date:</label>
                <input type="date" id="dueDateInput">
            </div>
            
            <div class="form-row">
                <label>Description:</label>
                <textarea id="descriptionInput" placeholder="Add task description (optional)..."></textarea>
            </div>
            
            <div class="form-row">
                <label>Categories:</label>
                <input type="text" id="categoriesInput" placeholder="Add categories/tags (comma separated): work, personal, urgent..." 
                       style="flex: 2;">
            </div>
            
            <div class="form-row">
                <label>Priority:</label>
                <select id="priorityInput">
                    <option value="high">üî¥ High Priority</option>
                    <option value="medium" selected>üü° Medium Priority</option>
                    <option value="low">üü¢ Low Priority</option>
                </select>
                <label>Progress:</label>
                <select id="progressInput">
                    <option value="0">0% - Not Started</option>
                    <option value="25">25% - In Progress</option>
                    <option value="50">50% - Half Done</option>
                    <option value="75">75% - Almost Done</option>
                    <option value="100">100% - Complete</option>
                </select>
                <button onclick="addTodo()" id="addTaskBtn">Add Task</button>
                <button onclick="cancelEdit()" id="cancelEditBtn" style="display: none;">Cancel Edit</button>
            </div>
        </div>

        <div class="search-container" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 300px;">
                <label for="searchInput" style="font-size: 14px; color: #495057; white-space: nowrap;">üîç Search:</label>
                <input type="text" id="searchInput" placeholder="Search tasks by title or description..." 
                       style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;"
                       oninput="updateSearch()">
                <button onclick="clearSearch()" style="padding: 10px 15px; background: #6c757d; color: white; border: none; border-radius: 5px; font-size: 14px;">Clear</button>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="font-size: 14px; color: #495057; white-space: nowrap;">üì§ Export:</label>
                <button onclick="exportAsJSON()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 14px;">JSON</button>
                <button onclick="exportAsCSV()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 5px; font-size: 14px;">CSV</button>
                <button onclick="exportAsText()" style="padding: 8px 12px; background: #ffc107; color: black; border: none; border-radius: 5px; font-size: 14px;">Text</button>
            </div>
        </div>

        <div class="select-all-container">
            <input type="checkbox" id="selectAllCheckbox" class="bulk-checkbox" onchange="toggleSelectAll()">
            <label for="selectAllCheckbox"><strong>Select All Tasks</strong></label>
            <span id="selectedCount" style="margin-left: auto; color: #666; font-size: 14px;">0 selected</span>
        </div>

        <div class="bulk-actions" id="bulkActions">
            <strong>Bulk Actions:</strong>
            <button onclick="bulkComplete()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 5px; font-size: 14px;">‚úì Mark Complete</button>
            <button onclick="bulkIncomplete()" style="background: #ffc107; color: black; padding: 8px 16px; border: none; border-radius: 5px; font-size: 14px;">‚Ü∂ Mark Incomplete</button>
            <button onclick="bulkDelete()" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 5px; font-size: 14px;">üóë Delete Selected</button>
            <button onclick="clearSelection()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 5px; font-size: 14px;">‚úï Clear Selection</button>
        </div>

        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterTodos('all')" id="filterAll">All Tasks</button>
            <button class="filter-btn" onclick="filterTodos('in-progress')" id="filterInProgress">In Progress</button>
            <button class="filter-btn" onclick="filterTodos('completed')" id="filterCompleted">Completed</button>
            
            <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                <label for="sortSelect" style="font-size: 14px; color: #495057;">Sort by:</label>
                <select id="sortSelect" onchange="updateSort()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    <option value="created">Date Created</option>
                    <option value="title">Title (A-Z)</option>
                    <option value="due">Due Date</option>
                    <option value="priority">Priority</option>
                    <option value="progress">Progress</option>
                </select>
            </div>
        </div>

        <ul class="todo-list" id="todoList">
            <!-- Todo items will appear here -->
        </ul>
    </div>

    <script>
        // This array will store all our todo items with enhanced fields
        let todos = [];
        let currentFilter = 'all';
        let currentSort = 'created';
        let currentSearch = '';
        let editingTodoId = null; // Track which todo is being edited
        let selectedTodos = new Set(); // Track selected todos for bulk actions
        let draggedTodoId = null; // Track which todo is being dragged

        // Collection of Quran verses that rotate daily
        const quranVerses = [
            { text: "And whoever relies upon Allah - then He is sufficient for him. Indeed, Allah will accomplish His purpose.", reference: "Surah At-Talaq 65:3" },
            { text: "And it is He who created the heavens and earth in truth. And the day He says, \"Be,\" and it is, His word is the truth.", reference: "Surah Al-An'am 6:73" },
            { text: "And whoever fears Allah - He will make for him a way out.", reference: "Surah At-Talaq 65:2" },
            { text: "And whoever does righteous deeds, whether male or female, while being a believer - those will enter Paradise.", reference: "Surah An-Nisa 4:124" },
            { text: "And Allah would not punish them while they seek forgiveness.", reference: "Surah Al-Anfal 8:33" },
            { text: "And give good tidings to those who believe and do righteous deeds that they will have gardens.", reference: "Surah Al-Baqarah 2:25" },
            { text: "And whoever believes in Allah and does righteousness - He will admit him into gardens beneath which rivers flow.", reference: "Surah At-Taghabun 64:9" },
            { text: "And Allah is the best of planners.", reference: "Surah Al-Anfal 8:30" },
            { text: "So remember Me; I will remember you. And be grateful to Me and do not deny Me.", reference: "Surah Al-Baqarah 2:152" },
            { text: "And whoever trusts in Allah - then He is sufficient for him.", reference: "Surah At-Talaq 65:3" },
            { text: "Indeed, with hardship comes ease.", reference: "Surah Ash-Sharh 94:6" },
            { text: "And Allah loves the doers of good.", reference: "Surah Al-Baqarah 2:195" },
            { text: "And seek help through patience and prayer.", reference: "Surah Al-Baqarah 2:45" },
            { text: "And it is Allah who sends down rain from heaven, and We produce thereby the vegetation of every kind.", reference: "Surah Al-An'am 6:99" },
            { text: "And whoever does good deeds, whether male or female, and is a believer - such will enter Paradise.", reference: "Surah Ghafir 40:40" }
        ];

        // Get daily verse based on current date
        function getDailyVerse() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const verseIndex = dayOfYear % quranVerses.length;
            return quranVerses[verseIndex];
        }

        // Priority weights for completion calculation
        const priorityWeights = {
            high: 3,    // High priority tasks count 3x
            medium: 2,  // Medium priority tasks count 2x
            low: 1      // Low priority tasks count 1x
        };

        // Update statistics display with weighted completion
        function updateStats() {
            const totalTasks = todos.length;
            const completedTasks = todos.filter(todo => todo.completed).length;
            const inProgressTasks = totalTasks - completedTasks;
            
            // Calculate weighted completion rate
            let totalWeight = 0;
            let completedWeight = 0;
            
            todos.forEach(todo => {
                const weight = priorityWeights[todo.priority || 'medium'];
                totalWeight += weight;
                if (todo.completed) {
                    completedWeight += weight;
                }
            });
            
            const weightedCompletionRate = totalWeight > 0 ? Math.round((completedWeight / totalWeight) * 100) : 0;

            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('completionRate').textContent = weightedCompletionRate + '%';
        }

        // Load daily verse
        function loadDailyVerse() {
            const dailyVerse = getDailyVerse();
            document.getElementById('verseText').textContent = dailyVerse.text;
            document.getElementById('verseReference').textContent = '‚Äî ' + dailyVerse.reference;
        }

        // Load saved todos from localStorage when the page starts
        function loadTodos() {
            const savedTodos = localStorage.getItem('myEnhancedTodos');
            if (savedTodos) {
                todos = JSON.parse(savedTodos);
                displayTodos();
                updateStats();
            }
            loadDailyVerse();
        }

        // Save todos to localStorage
        function saveTodos() {
            localStorage.setItem('myEnhancedTodos', JSON.stringify(todos));
        }

        // This function adds a new todo or updates an existing one
        function addTodo() {
            // Get all form values
            const titleInput = document.getElementById('todoInput');
            const dueDateInput = document.getElementById('dueDateInput');
            const descriptionInput = document.getElementById('descriptionInput');
            const categoriesInput = document.getElementById('categoriesInput');
            const priorityInput = document.getElementById('priorityInput');
            const progressInput = document.getElementById('progressInput');

            const todoTitle = titleInput.value.trim();
            const dueDate = dueDateInput.value;
            const description = descriptionInput.value.trim();
            const categories = processCategories(categoriesInput.value);
            const priority = priorityInput.value;
            const progress = parseInt(progressInput.value);

            // Check if the user entered a title
            if (todoTitle === '') {
                shakeFormOnError('todoInput');
                return;
            }

            if (editingTodoId) {
                // We're editing an existing todo
                const todoIndex = todos.findIndex(t => t.id === editingTodoId);
                if (todoIndex !== -1) {
                    // Update existing todo (preserve original creation date)
                    todos[todoIndex] = {
                        ...todos[todoIndex], // Keep existing properties
                        title: todoTitle,
                        description: description,
                        dueDate: dueDate,
                        categories: categories,
                        priority: priority,
                        progress: progress,
                        completed: progress === 100 // Auto-complete if 100%
                    };
                }
                
                // Exit edit mode
                cancelEdit();
            } else {
                // Create a new enhanced todo object
                const newTodo = {
                    id: Date.now(),
                    title: todoTitle,
                    description: description,
                    dueDate: dueDate,
                    categories: categories,
                    priority: priority,
                    progress: progress,
                    completed: progress === 100, // Auto-complete if 100%
                    createdDate: new Date().toISOString().split('T')[0]
                };

                // Add the new todo to our array
                todos.push(newTodo);

                // Clear all input fields
                titleInput.value = '';
                dueDateInput.value = '';
                descriptionInput.value = '';
                categoriesInput.value = '';
                priorityInput.value = 'medium';
                progressInput.value = '0';
            }

            // Save to localStorage
            saveTodos();

            // Update the display with animations
            displayTodos();
            updateStats();
            animateStatNumbers();
        }

        // This function shows todos based on current filter
        function displayTodos() {
            const todoList = document.getElementById('todoList');
            todoList.innerHTML = '';

            // Filter todos based on current filter and search
            let filteredTodos = todos.filter(todo => {
                // First apply status filter
                let statusMatch = true;
                if (currentFilter === 'completed') statusMatch = todo.completed;
                else if (currentFilter === 'in-progress') statusMatch = !todo.completed;
                
                // Then apply search filter
                let searchMatch = true;
                if (currentSearch) {
                    const searchLower = currentSearch.toLowerCase();
                    const titleMatch = todo.title.toLowerCase().includes(searchLower);
                    const descriptionMatch = (todo.description || '').toLowerCase().includes(searchLower);
                    const categoriesMatch = (todo.categories || []).some(cat => 
                        cat.toLowerCase().includes(searchLower)
                    );
                    searchMatch = titleMatch || descriptionMatch || categoriesMatch;
                }
                
                return statusMatch && searchMatch;
            });

            // Sort the filtered todos
            filteredTodos = sortTodos([...filteredTodos]); // Create copy to avoid mutating original

            // Display message if no todos match filter
            if (filteredTodos.length === 0) {
                const message = document.createElement('p');
                message.style.textAlign = 'center';
                message.style.color = '#666';
                message.style.fontStyle = 'italic';
                message.textContent = `No ${currentFilter === 'all' ? '' : currentFilter} tasks found.`;
                todoList.appendChild(message);
                return;
            }

            // Create HTML for each filtered todo
            filteredTodos.forEach((todo, index) => {
                const listItem = document.createElement('li');
                const priority = todo.priority || 'medium';
                const isSelected = selectedTodos.has(todo.id);
                listItem.className = `todo-item priority-${priority} ${todo.completed ? 'completed' : ''} ${isSelected ? 'selected' : ''}`;
                
                // Add drag and drop attributes
                listItem.draggable = true;
                listItem.dataset.todoId = todo.id;
                
                // Format due date for display
                const dueDateText = todo.dueDate 
                    ? new Date(todo.dueDate).toLocaleDateString() 
                    : 'No due date';

                // Priority display mapping
                const priorityDisplay = {
                    high: 'üî¥ High',
                    medium: 'üü° Medium', 
                    low: 'üü¢ Low'
                };
                
                listItem.innerHTML = `
                    <div class="todo-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleTodoSelection(${todo.id})">
                            <div class="todo-title ${todo.completed ? 'completed' : ''}">
                                ${todo.title}
                                <span class="priority-badge priority-${priority}">
                                    ${priorityDisplay[priority]}
                                </span>
                            </div>
                        </div>
                        <div class="todo-actions">
                            <div class="progress-container">
                                <select class="progress-select" onchange="updateProgress(${todo.id}, this.value)">
                                    <option value="0" ${todo.progress === 0 ? 'selected' : ''}>0%</option>
                                    <option value="25" ${todo.progress === 25 ? 'selected' : ''}>25%</option>
                                    <option value="50" ${todo.progress === 50 ? 'selected' : ''}>50%</option>
                                    <option value="75" ${todo.progress === 75 ? 'selected' : ''}>75%</option>
                                    <option value="100" ${todo.progress === 100 ? 'selected' : ''}>100%</option>
                                </select>
                            </div>
                            <button class="edit-btn" onclick="editTodo(${todo.id})">Edit</button>
                            <button class="delete-btn" onclick="deleteTodo(${todo.id})">Delete</button>
                        </div>
                    </div>
                    
                    ${todo.description ? `
                        <div class="todo-details">
                            <div class="todo-description">${todo.description}</div>
                        </div>
                    ` : ''}
                    
                    ${todo.categories && todo.categories.length > 0 ? `
                        <div class="categories-container">
                            <strong>Categories:</strong> ${generateCategoryTags(todo.categories, true)}
                        </div>
                    ` : ''}
                    
                    <div class="todo-meta">
                        <span class="todo-due-date ${todo.completed ? 'completed' : ''}">
                            üìÖ Due: ${dueDateText}
                        </span>
                        <span>üìä Progress: ${todo.progress}%</span>
                        <span>üèÜ Priority: ${priorityDisplay[priority]} (Weight: ${priorityWeights[priority]}x)</span>
                        <span>üìÖ Created: ${new Date(todo.createdDate).toLocaleDateString()}</span>
                    </div>
                `;

                // Add drag and drop event listeners
                addDragAndDropListeners(listItem);

                todoList.appendChild(listItem);
            });

            // Update bulk actions visibility and selection count
            updateBulkActionsDisplay();
        }

        // Update progress and auto-complete at 100%
        function updateProgress(id, newProgress) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.progress = parseInt(newProgress);
                todo.completed = todo.progress === 100; // Auto-complete at 100%
                saveTodos();
                displayTodos();
                updateStats();
                animateStatNumbers();
            }
        }

        // Filter todos by status
        function filterTodos(filter) {
            currentFilter = filter;
            
            // Update filter button styles
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1).replace('-', '')).classList.add('active');
            
            displayTodos();
            addFadeInToNewItems();
        }

        // Update sort option
        function updateSort() {
            currentSort = document.getElementById('sortSelect').value;
            displayTodos();
            addFadeInToNewItems();
        }

        // Update search
        function updateSearch() {
            currentSearch = document.getElementById('searchInput').value.toLowerCase().trim();
            displayTodos();
            addFadeInToNewItems();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            displayTodos();
            addFadeInToNewItems();
        }

        // Process categories from comma-separated string
        function processCategories(categoriesString) {
            if (!categoriesString || !categoriesString.trim()) return [];
            return categoriesString
                .split(',')
                .map(cat => cat.trim().toLowerCase())
                .filter(cat => cat.length > 0);
        }

        // Generate category tags HTML
        function generateCategoryTags(categories, clickable = false) {
            if (!categories || categories.length === 0) return '';
            
            return categories.map(category => {
                const clickHandler = clickable ? `onclick="filterByCategory('${category}')"` : '';
                return `<span class="category-tag" ${clickHandler}>${category}</span>`;
            }).join('');
        }

        // Filter by category (when clicking on a category tag)
        function filterByCategory(category) {
            document.getElementById('searchInput').value = category;
            currentSearch = category.toLowerCase();
            displayTodos();
            addFadeInToNewItems();
        }

        // Sort todos based on current sort option
        function sortTodos(todosToSort) {
            return todosToSort.sort((a, b) => {
                switch(currentSort) {
                    case 'title':
                        return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
                    
                    case 'due':
                        // Handle empty due dates
                        if (!a.dueDate && !b.dueDate) return 0;
                        if (!a.dueDate) return 1; // Empty dates go to end
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    
                    case 'priority':
                        const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                        return priorityOrder[b.priority || 'medium'] - priorityOrder[a.priority || 'medium'];
                    
                    case 'progress':
                        return (b.progress || 0) - (a.progress || 0); // Highest progress first
                    
                    case 'created':
                    default:
                        return new Date(b.createdDate) - new Date(a.createdDate); // Newest first
                }
            });
        }

        // Delete a todo with animation
        function deleteTodo(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                // Try to animate the deletion
                if (!animateDelete(id)) {
                    // Fallback if animation fails
                    todos = todos.filter(todo => todo.id !== id);
                    saveTodos();
                    displayTodos();
                    updateStats();
                    animateStatNumbers();
                }
            }
        }

        // Edit a todo - populate form with existing data
        function editTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            // Set editing mode
            editingTodoId = id;

            // Populate form fields
            document.getElementById('todoInput').value = todo.title;
            document.getElementById('dueDateInput').value = todo.dueDate || '';
            document.getElementById('descriptionInput').value = todo.description || '';
            document.getElementById('categoriesInput').value = (todo.categories || []).join(', ');
            document.getElementById('priorityInput').value = todo.priority || 'medium';
            document.getElementById('progressInput').value = todo.progress || 0;

            // Update button states
            document.getElementById('addTaskBtn').textContent = 'Update Task';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // Scroll to form
            document.getElementById('todoInput').focus();
        }

        // Cancel editing mode
        function cancelEdit() {
            editingTodoId = null;

            // Clear form fields
            document.getElementById('todoInput').value = '';
            document.getElementById('dueDateInput').value = '';
            document.getElementById('descriptionInput').value = '';
            document.getElementById('categoriesInput').value = '';
            document.getElementById('priorityInput').value = 'medium';
            document.getElementById('progressInput').value = '0';

            // Reset button states
            document.getElementById('addTaskBtn').textContent = 'Add Task';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // Animation helper functions
        function showLoadingButton(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.add('loading');
                button.disabled = true;
            }
        }

        function hideLoadingButton(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        function animateStatNumbers() {
            const statNumbers = document.querySelectorAll('.stat-number');
            statNumbers.forEach(stat => {
                stat.classList.add('success-pulse');
                setTimeout(() => {
                    stat.classList.remove('success-pulse');
                }, 600);
            });
        }

        function shakeFormOnError(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.classList.add('error-shake');
                setTimeout(() => {
                    input.classList.remove('error-shake');
                }, 500);
            }
        }

        function animateDelete(todoId) {
            const todoItems = document.querySelectorAll('.todo-item');
            let targetItem = null;
            
            // Find the todo item by checking the delete button's onclick attribute
            todoItems.forEach(item => {
                const deleteBtn = item.querySelector('.delete-btn');
                if (deleteBtn && deleteBtn.getAttribute('onclick').includes(todoId)) {
                    targetItem = item;
                }
            });
            
            if (targetItem) {
                targetItem.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    // Actually remove the todo after animation
                    todos = todos.filter(todo => todo.id !== todoId);
                    saveTodos();
                    displayTodos();
                    updateStats();
                    animateStatNumbers();
                }, 300);
                return true; // Indicate we're handling the animation
            }
            return false; // Fallback to immediate deletion
        }

        function addFadeInToNewItems() {
            // Add fade-in class to todo list container
            const todoList = document.getElementById('todoList');
            if (todoList) {
                todoList.classList.add('fade-in');
                setTimeout(() => {
                    todoList.classList.remove('fade-in');
                }, 500);
            }
        }

        // Export functions
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportAsJSON() {
            // Show loading (simulate brief processing time)
            const button = event.target;
            button.classList.add('loading');
            button.disabled = true;
            
            setTimeout(() => {
                const exportData = {
                    exportDate: new Date().toISOString(),
                    totalTasks: todos.length,
                    completedTasks: todos.filter(t => t.completed).length,
                    todos: todos
                };
                
                const jsonContent = JSON.stringify(exportData, null, 2);
                downloadFile(jsonContent, `todos-export-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
                
                button.classList.remove('loading');
                button.disabled = false;
            }, 500);
        }

        function exportAsCSV() {
            const button = event.target;
            button.classList.add('loading');
            button.disabled = true;
            
            setTimeout(() => {
                const headers = ['Title', 'Description', 'Due Date', 'Categories', 'Priority', 'Progress', 'Completed', 'Created Date'];
                const csvRows = [headers.join(',')];
                
                todos.forEach(todo => {
                    const row = [
                        `"${(todo.title || '').replace(/"/g, '""')}"`,
                        `"${(todo.description || '').replace(/"/g, '""')}"`,
                        todo.dueDate || '',
                        `"${(todo.categories || []).join('; ')}"`,
                        todo.priority || 'medium',
                        todo.progress || 0,
                        todo.completed ? 'Yes' : 'No',
                        todo.createdDate || ''
                    ];
                    csvRows.push(row.join(','));
                });
                
                downloadFile(csvRows.join('\n'), `todos-export-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
                
                button.classList.remove('loading');
                button.disabled = false;
            }, 400);
        }

        function exportAsText() {
            const button = event.target;
            button.classList.add('loading');
            button.disabled = true;
            
            setTimeout(() => {
                const lines = [];
                lines.push('='.repeat(50));
            lines.push('TODO LIST EXPORT');
            lines.push(`Generated: ${new Date().toLocaleString()}`);
            lines.push(`Total Tasks: ${todos.length}`);
            lines.push(`Completed: ${todos.filter(t => t.completed).length}`);
            lines.push(`In Progress: ${todos.filter(t => !t.completed).length}`);
            lines.push('='.repeat(50));
            lines.push('');

            // Group by status
            const completedTodos = todos.filter(t => t.completed);
            const inProgressTodos = todos.filter(t => !t.completed);

            if (inProgressTodos.length > 0) {
                lines.push('üìã IN PROGRESS TASKS:');
                lines.push('-'.repeat(30));
                inProgressTodos.forEach((todo, index) => {
                    lines.push(`${index + 1}. ${todo.title}`);
                    if (todo.description) lines.push(`   Description: ${todo.description}`);
                    if (todo.dueDate) lines.push(`   Due: ${new Date(todo.dueDate).toLocaleDateString()}`);
                    if (todo.categories && todo.categories.length > 0) lines.push(`   Categories: ${todo.categories.join(', ')}`);
                    lines.push(`   Priority: ${(todo.priority || 'medium').toUpperCase()}`);
                    lines.push(`   Progress: ${todo.progress || 0}%`);
                    lines.push('');
                });
            }

            if (completedTodos.length > 0) {
                lines.push('‚úÖ COMPLETED TASKS:');
                lines.push('-'.repeat(30));
                completedTodos.forEach((todo, index) => {
                    lines.push(`${index + 1}. ${todo.title}`);
                    if (todo.description) lines.push(`   Description: ${todo.description}`);
                    if (todo.categories && todo.categories.length > 0) lines.push(`   Categories: ${todo.categories.join(', ')}`);
                    lines.push(`   Completed: ${new Date(todo.createdDate).toLocaleDateString()}`);
                    lines.push('');
                });
            }

                downloadFile(lines.join('\n'), `todos-export-${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
                
                button.classList.remove('loading');
                button.disabled = false;
            }, 600);
        }

        // Drag and Drop Functions
        function addDragAndDropListeners(listItem) {
            listItem.addEventListener('dragstart', handleDragStart);
            listItem.addEventListener('dragover', handleDragOver);
            listItem.addEventListener('drop', handleDrop);
            listItem.addEventListener('dragenter', handleDragEnter);
            listItem.addEventListener('dragleave', handleDragLeave);
            listItem.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            draggedTodoId = parseInt(this.dataset.todoId);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (parseInt(this.dataset.todoId) !== draggedTodoId) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetTodoId = parseInt(this.dataset.todoId);
            if (draggedTodoId && targetTodoId && draggedTodoId !== targetTodoId) {
                // Find the indices of the dragged and target todos
                const draggedIndex = todos.findIndex(t => t.id === draggedTodoId);
                const targetIndex = todos.findIndex(t => t.id === targetTodoId);

                if (draggedIndex !== -1 && targetIndex !== -1) {
                    // Remove the dragged item and insert it before the target
                    const draggedTodo = todos.splice(draggedIndex, 1)[0];
                    todos.splice(targetIndex, 0, draggedTodo);
                    
                    // Save and refresh
                    saveTodos();
                    displayTodos();
                    animateStatNumbers();
                }
            }

            this.classList.remove('drag-over');
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Clean up all drag-over classes
            document.querySelectorAll('.todo-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            
            draggedTodoId = null;
        }

        // Bulk Selection Functions
        function toggleTodoSelection(todoId) {
            if (selectedTodos.has(todoId)) {
                selectedTodos.delete(todoId);
            } else {
                selectedTodos.add(todoId);
            }
            updateBulkActionsDisplay();
            displayTodos(); // Refresh to show selection state
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const visibleTodos = getFilteredTodos();
            
            if (checkbox.checked) {
                // Select all visible todos
                visibleTodos.forEach(todo => selectedTodos.add(todo.id));
            } else {
                // Deselect all todos
                selectedTodos.clear();
            }
            
            updateBulkActionsDisplay();
            displayTodos();
        }

        function updateBulkActionsDisplay() {
            const selectedCount = selectedTodos.size;
            const bulkActions = document.getElementById('bulkActions');
            const selectedCountSpan = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            // Update count display
            selectedCountSpan.textContent = `${selectedCount} selected`;
            
            // Show/hide bulk actions
            if (selectedCount > 0) {
                bulkActions.classList.add('visible');
            } else {
                bulkActions.classList.remove('visible');
            }
            
            // Update select all checkbox state
            const visibleTodos = getFilteredTodos();
            if (selectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCount === visibleTodos.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        function getFilteredTodos() {
            return todos.filter(todo => {
                // Apply same filtering logic as displayTodos
                let statusMatch = true;
                if (currentFilter === 'completed') statusMatch = todo.completed;
                else if (currentFilter === 'in-progress') statusMatch = !todo.completed;
                
                let searchMatch = true;
                if (currentSearch) {
                    const searchLower = currentSearch.toLowerCase();
                    const titleMatch = todo.title.toLowerCase().includes(searchLower);
                    const descriptionMatch = (todo.description || '').toLowerCase().includes(searchLower);
                    const categoriesMatch = (todo.categories || []).some(cat => 
                        cat.toLowerCase().includes(searchLower)
                    );
                    searchMatch = titleMatch || descriptionMatch || categoriesMatch;
                }
                
                return statusMatch && searchMatch;
            });
        }

        function clearSelection() {
            selectedTodos.clear();
            updateBulkActionsDisplay();
            displayTodos();
        }

        function bulkComplete() {
            if (selectedTodos.size === 0) return;
            
            if (confirm(`Mark ${selectedTodos.size} selected tasks as complete?`)) {
                todos.forEach(todo => {
                    if (selectedTodos.has(todo.id)) {
                        todo.completed = true;
                        todo.progress = 100;
                    }
                });
                
                saveTodos();
                displayTodos();
                updateStats();
                animateStatNumbers();
                clearSelection();
            }
        }

        function bulkIncomplete() {
            if (selectedTodos.size === 0) return;
            
            if (confirm(`Mark ${selectedTodos.size} selected tasks as incomplete?`)) {
                todos.forEach(todo => {
                    if (selectedTodos.has(todo.id)) {
                        todo.completed = false;
                        if (todo.progress === 100) {
                            todo.progress = 75; // Set to 75% when marking incomplete
                        }
                    }
                });
                
                saveTodos();
                displayTodos();
                updateStats();
                animateStatNumbers();
                clearSelection();
            }
        }

        function bulkDelete() {
            if (selectedTodos.size === 0) return;
            
            if (confirm(`Delete ${selectedTodos.size} selected tasks? This cannot be undone.`)) {
                todos = todos.filter(todo => !selectedTodos.has(todo.id));
                
                saveTodos();
                displayTodos();
                updateStats();
                animateStatNumbers();
                clearSelection();
            }
        }

        // Keyboard shortcuts for common actions
        document.addEventListener('keydown', function(e) {
            // Ctrl+N or Cmd+N - Focus on new task input
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                document.getElementById('todoInput').focus();
            }
            
            // Escape key - Cancel editing or clear form
            if (e.key === 'Escape') {
                if (editingTodoId) {
                    cancelEdit();
                } else {
                    // Clear form if not editing
                    document.getElementById('todoInput').value = '';
                    document.getElementById('dueDateInput').value = '';
                    document.getElementById('descriptionInput').value = '';
                    document.getElementById('priorityInput').value = 'medium';
                    document.getElementById('progressInput').value = '0';
                }
            }
            
            // Ctrl+S or Cmd+S - Save/Add todo
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (document.getElementById('todoInput').value.trim()) {
                    addTodo();
                }
            }
            
            // Ctrl+1, 2, 3, 4 - Switch filters and sort
            if (e.ctrlKey || e.metaKey) {
                if (e.key === '1') {
                    e.preventDefault();
                    filterTodos('all');
                } else if (e.key === '2') {
                    e.preventDefault();
                    filterTodos('in-progress');
                } else if (e.key === '3') {
                    e.preventDefault();
                    filterTodos('completed');
                } else if (e.key === '4') {
                    e.preventDefault();
                    // Cycle through sort options
                    const sortSelect = document.getElementById('sortSelect');
                    const sortOptions = ['created', 'title', 'due', 'priority', 'progress'];
                    const currentIndex = sortOptions.indexOf(currentSort);
                    const nextIndex = (currentIndex + 1) % sortOptions.length;
                    sortSelect.value = sortOptions[nextIndex];
                    updateSort();
                }
            }
            
            // Bulk action shortcuts
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'a' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    // Select all visible todos
                    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                    selectAllCheckbox.checked = true;
                    toggleSelectAll();
                } else if (e.key === 'd' && selectedTodos.size > 0) {
                    e.preventDefault();
                    bulkDelete();
                }
            }
        });

        // Allow adding todos by pressing Enter in title field
        document.getElementById('todoInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        // Load todos when the page first loads
        window.addEventListener('load', loadTodos);
    </script>
</body>
</html>